.run_everything_rules: &run_everything_rules
  refs:
    - develop
    - releases
    - schedules
    - /^release\//

# @trezor/suite-desktop
.e2e desktop:
  stage: integration testing
  retry: 1
  dependencies:
    - install
  variables:
    COMPOSE_PROJECT_NAME: $CI_JOB_ID # for unique containers
    COMPOSE_FILE: ./docker/docker-compose.suite-desktop-ci.yml
    TEST_FILE: $TEST_FILE
  before_script:
    - docker login $CI_DEPENDENCY_PROXY_SERVER -u $CI_DEPENDENCY_PROXY_USER -p $CI_DEPENDENCY_PROXY_PASSWORD
  script:
    - yarn install --immutable
    # 3 next steps could be removed if we passed packages/suite-desktop/dist and build folder as an artifact
    # but since this is run only in nightly builds it can be probably built inside the job for now..
    - yarn message-system-sign-config
    - yarn workspace @trezor/suite-desktop build:linux
    - docker-compose pull
    - docker-compose up -d ${CONTAINERS}
    - docker-compose run test-run
  after_script:
    - docker-compose down
    - docker network prune -f
  artifacts:
    expire_in: 7 days
    when: always
    paths:
      - "**/test-results/**"
  interruptible: true
  parallel:
    matrix:
      - TEST_FILE: ["spawn-tor", "spawn-bridge", "suite-guide", "wallet-discovery"]
        CONTAINERS: "trezor-user-env-unix"
      - TEST_FILE: ["electrum"]
        CONTAINERS: "trezor-user-env-unix electrum-regtest"
      # commented out. coinjoin test is not adapted to current state of this feature
      # - TEST_FILE: ["coinjoin"]
      #   CONTAINERS: "trezor-user-env-unix coinjoin-backend"

suite desktop:
  extends: .e2e desktop
  only:
    <<: *run_everything_rules

suite desktop manual:
  extends: .e2e desktop
  except:
    <<: *run_everything_rules
  when: manual
